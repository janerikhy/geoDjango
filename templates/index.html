{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' /> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/ab01cf2660.js" crossorigin="anonymous"></script>
    <link type="text/css" href="{% static 'css/styles.css' %}" rel="stylesheet">
    <title>iMap</title>
</head>
<body>
    <nav class="navbar navbar-dark navbar-expand" style="z-index: 2;">
        <div class="container">
          <a class="navbar-brand" href="#">
            <i class="fas fa-user-astronaut"></i>
          </a>
          <ul class="navbar-nav">
              <li class="nav-item"><a class="nav-link" href="{% url 'upload' %}">Add Observation</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'leaderboard' %}">Leaderboard</a></li>
              {% if user.is_authenticated %}
                <li class="nav-item"><a class="nav-link" href="{% url 'profile' pk=request.user.pk %}">Profile</a></li>
              {% else %}
              <li class="nav-item"><a class="nav-link" href="{% url 'sign_up' %}">Sign Up</a></li>  
              {% endif %}
              {% if user.is_authenticated %}
              <li class="nav-item"><a href="{% url 'project_create' %}" class="nav-link">Create Projects</a></li>
              {% endif %}
              <li class="nav-item"><a href="{% url 'projects' %}" class="nav-link">Projects</a></li>
          </ul>
        </div>
      </nav>
    <div id='map'></div>
    {% for obs in observations %}
        {{obs.address}}
    {% endfor %}
    
<script>
// TO MAKE THE MAP APPEAR YOU MUST
// ADD YOUR ACCESS TOKEN FROM
// https://account.mapbox.com
mapboxgl.accessToken = 'pk.eyJ1Ijoib2NlYW5kYXRhZm91bmRhdGlvbiIsImEiOiJjazk5bGxpNWkwYWU1M2Vya3hkcHh4czdrIn0.yf7kIiPfDNE7KP9_9wTN6A';
var map = new mapboxgl.Map({
container: 'map', // container id
style: 'mapbox://styles/oceandatafoundation/ckbujyuqu0kah1kpbctq4lemg', // style URL
center: [10.588725, 59.836199], // starting position [lng, lat]
zoom: 10 // starting zoom
});

{% for area in areas %}

map.on('load', function () {
// Add a data source containing GeoJSON data.
map.addSource('{{area.name}}', {
        'type': 'geojson',
        'data': {
            'type': 'Feature',
            'geometry': {{area.area.geojson|safe}} 
    
    }
});
map.addLayer({
    'id': '{{area.name}}',
    'type': 'fill',
    'source': '{{area.name}}', // reference the data source
    'layout': {},
    'paint': {
        'fill-color': '#0080ff', // blue color fill
        'fill-opacity': 0.5
    }
});
});

map.on('mouseenter', '{{area.name}}', ()=>{
    map.getCanvas().style.cursor = "pointer";
});

map.on('mouseleave', '{{area.name}}', ()=>{
    map.getCanvas().style.cursor = "";
});

map.on('click', '{{area.name}}', () => {
    console.log("Clicked {{area.name}}");
    console.log({{area.area.geojson|safe}});
    var lat = {{area.area.centroid.y}};
    var lon = {{area.area.centroid.x}};

    new mapboxgl.Popup()
        .setLngLat([lon, lat])
        .setHTML("<div class='lead'><a href='{% url 'aoi' area.id %}'> {{area.name}}</a></div>")
        .addTo(map);

})


{% endfor %}




// Iterating through all of the observations in the database. 
{% for observation in observations %}
    var marker = new mapboxgl.Marker()
    .setLngLat([{{observation.lon}}, {{observation.lat}}])
    .setPopup(new mapboxgl.Popup().setHTML("<div class='lead'>{{observation.obs_date|date:'D d M Y H:i'}}</div><img class='observation_img' src={{observation.image.url}}>"))
    .addTo(map);
{% endfor %}

map.on('mouseenter', '.marker', () => {
    map.getCanvas().style.cursor = "pointer";
});

map.on('mouseleave', 'marker', () => {
    map.getCanvas().style.cursor = "";
});

</script>
</body>
</html>